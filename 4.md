# Video Generation Platform - Implementation Plan

## Executive Summary

This document outlines the technical implementation for a three-tier video generation service using Pollo.ai's platform APIs. The system will offer users three quality/price tiers with a 210% markup on base costs.

---

## 1. Pricing Structure

### Base Costs (Pollo.ai Platform)
- **Pollo 1.6**: $0.10/second
- **Kling 2.5 Turbo**: $0.12/second  
- **Runway Gen-4 Turbo**: $0.30/second

### Customer Pricing (Custom Markup Strategy)

| Tier | Model | Cost per Second | 5s Video | 10s Video |
|------|-------|----------------|----------|-----------|
| **Economy** | Kling 1.6 | $0.20/sec | $1.00 | $2.00 |
| **Basic** | Pollo 1.6 | $0.31/sec | $1.55 | $3.10 |
| **Pro** | Kling 2.5 Turbo | $0.37/sec | $1.86 | $3.72 |
| **Premium** | Runway Gen-4 Turbo | $0.93/sec | $4.65 | $9.30 |

### Profit Margins
- Economy Tier: $0.13/sec profit (186% markup)
- Basic Tier: $0.21/sec profit (210% markup)
- Pro Tier: $0.25/sec profit (210% markup)
- Premium Tier: $0.63/sec profit (210% markup)

---

## 2. Technical Architecture

### 2.1 Core Components

```
┌─────────────┐
│   Frontend  │
│  (User UI)  │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────┐
│     Backend API Server          │
│  - Auth & User Management       │
│  - Payment Processing           │
│  - Credit/Balance Management    │
│  - Job Queue Management         │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│   Video Generation Worker       │
│  - API Integration Layer        │
│  - Pollo.ai Client              │
│  - Webhook Handler              │
└──────┬──────────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│       Pollo.ai Platform         │
│  - Pollo 1.6 API                │
│  - Kling 2.5 Turbo API          │
│  - Runway Gen-4 Turbo API       │
└─────────────────────────────────┘
```

### 2.2 Database Schema

```sql
-- Users Table
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    credits_balance DECIMAL(10,2) DEFAULT 0.00,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Video Generation Jobs
CREATE TABLE video_jobs (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    tier VARCHAR(20) NOT NULL, -- 'basic', 'pro', 'premium'
    status VARCHAR(20) NOT NULL, -- 'pending', 'processing', 'completed', 'failed'
    
    -- Input parameters
    prompt TEXT NOT NULL,
    negative_prompt TEXT,
    input_image_url TEXT,
    duration_seconds INTEGER NOT NULL,
    
    -- Pollo.ai tracking
    task_id VARCHAR(255),
    pollo_status VARCHAR(50),
    
    -- Output
    video_url TEXT,
    
    -- Pricing
    estimated_cost DECIMAL(10,2),
    actual_cost DECIMAL(10,2),
    user_charged DECIMAL(10,2),
    
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    
    INDEX idx_user_status (user_id, status),
    INDEX idx_task_id (task_id)
);

-- Transactions for audit trail
CREATE TABLE transactions (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    job_id UUID REFERENCES video_jobs(id),
    amount DECIMAL(10,2) NOT NULL,
    type VARCHAR(20) NOT NULL, -- 'charge', 'refund', 'credit_purchase'
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 3. API Integration Specifications

### 3.1 Tier Configuration

```javascript
const TIER_CONFIG = {
  economy: {
    name: 'Economy',
    model: 'kling-v1-6',
    endpoint: 'https://pollo.ai/api/platform/generation/kling-ai/kling-v1-6',
    basePrice: 0.07,
    customerPrice: 0.20,
    maxDuration: 10,
    features: ['Budget-friendly', 'Lifelike movements', 'Text & Image input', 'Good quality']
  },
  basic: {
    name: 'Basic',
    model: 'pollo-v1-6',
    endpoint: 'https://pollo.ai/api/platform/generation/pollo/pollo-v1-6',
    basePrice: 0.10,
    customerPrice: 0.31,
    maxDuration: 8,
    features: ['Text-to-video', 'Image-to-video', 'Fast generation']
  },
  pro: {
    name: 'Pro',
    model: 'kling-v2-5-turbo',
    endpoint: 'https://pollo.ai/api/platform/generation/kling-ai/kling-v2-5-turbo',
    basePrice: 0.12,
    customerPrice: 0.37,
    maxDuration: 10,
    features: ['Director-level cinematics', 'Enhanced motion', 'Pro camera control']
  },
  premium: {
    name: 'Premium',
    model: 'runway-gen-4-turbo',
    endpoint: 'https://pollo.ai/api/platform/generation/runway/runway-gen-4-turbo',
    basePrice: 0.30,
    customerPrice: 0.93,
    maxDuration: 10,
    features: ['Hollywood quality', 'Ultra-realistic', 'Maximum detail', '4K support']
  }
};
```

### 3.2 API Client Implementation

```javascript
class PolloVideoGenerator {
  constructor(apiKey) {
    this.apiKey = apiKey;
    this.baseHeaders = {
      'Content-Type': 'application/json',
      'x-api-key': apiKey
    };
  }

  async generateVideo(tier, params) {
    const config = TIER_CONFIG[tier];
    if (!config) throw new Error(`Invalid tier: ${tier}`);

    // Calculate cost before generation
    const estimatedCost = params.duration * config.customerPrice;

    // Build request payload based on tier
    const payload = this.buildPayload(tier, params);

    try {
      const response = await fetch(config.endpoint, {
        method: 'POST',
        headers: this.baseHeaders,
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      
      return {
        taskId: data.taskId,
        status: data.status,
        estimatedCost: estimatedCost
      };
    } catch (error) {
      console.error('Video generation failed:', error);
      throw error;
    }
  }

  buildPayload(tier, params) {
    const basePayload = {
      webhookUrl: params.webhookUrl
    };

    switch(tier) {
      case 'economy':
        return {
          ...basePayload,
          input: {
            prompt: params.prompt,
            negativePrompt: params.negativePrompt || undefined,
            image: params.image || undefined,
            imageTail: params.imageTail || undefined,
            length: params.duration,
            strength: params.strength || 50,
            mode: params.mode || 'std'
          }
        };

      case 'basic':
        return {
          ...basePayload,
          input: {
            prompt: params.prompt,
            image: params.image || undefined,
            imageTail: params.imageTail || undefined,
            resolution: params.resolution || '480p',
            mode: params.mode || 'basic',
            length: params.duration,
            seed: params.seed || Math.floor(Math.random() * 10000)
          }
        };

      case 'pro':
        return {
          ...basePayload,
          input: {
            prompt: params.prompt,
            negativePrompt: params.negativePrompt || undefined,
            image: params.image || undefined,
            strength: params.strength || 50,
            length: params.duration
          }
        };

      case 'premium':
        return {
          ...basePayload,
          input: {
            prompt: params.prompt,
            negativePrompt: params.negativePrompt || undefined,
            image: params.image || undefined,
            resolution: params.resolution || '1920x1080',
            duration: params.duration,
            motionStrength: params.motionStrength || undefined
          }
        };
    }
  }

  async checkStatus(taskId) {
    // Poll Pollo.ai status endpoint
    // Implementation depends on their status check API
    // Return: { status, videoUrl }
  }
}
```

### 3.3 Webhook Handler

```javascript
// Express.js webhook endpoint
app.post('/api/webhooks/pollo', async (req, res) => {
  const { taskId, status, videoUrl } = req.body;

  try {
    // Find job by taskId
    const job = await db.query(
      'SELECT * FROM video_jobs WHERE task_id = $1',
      [taskId]
    );

    if (!job.rows[0]) {
      return res.status(404).json({ error: 'Job not found' });
    }

    const jobData = job.rows[0];

    // Update job status
    await db.query(
      `UPDATE video_jobs 
       SET status = $1, 
           pollo_status = $2, 
           video_url = $3,
           completed_at = NOW()
       WHERE task_id = $4`,
      [
        status === 'succeed' ? 'completed' : 'failed',
        status,
        videoUrl,
        taskId
      ]
    );

    // If failed, refund user
    if (status === 'failed') {
      await db.query(
        `UPDATE users 
         SET credits_balance = credits_balance + $1 
         WHERE id = $2`,
        [jobData.user_charged, jobData.user_id]
      );

      await db.query(
        `INSERT INTO transactions (user_id, job_id, amount, type, description)
         VALUES ($1, $2, $3, 'refund', 'Generation failed - refunded')`,
        [jobData.user_id, jobData.id, jobData.user_charged]
      );
    }

    // Notify user (email, push notification, etc.)
    await notifyUser(jobData.user_id, status, videoUrl);

    res.json({ success: true });
  } catch (error) {
    console.error('Webhook processing error:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});
```

---

## 4. User Flow Implementation

### 4.1 Video Generation Endpoint

```javascript
app.post('/api/videos/generate', authenticate, async (req, res) => {
  const { tier, prompt, negativePrompt, image, duration } = req.body;
  const userId = req.user.id;

  try {
    // 1. Validate tier
    const tierConfig = TIER_CONFIG[tier];
    if (!tierConfig) {
      return res.status(400).json({ error: 'Invalid tier selected' });
    }

    // 2. Calculate cost
    const estimatedCost = duration * tierConfig.customerPrice;

    // 3. Check user balance
    const user = await db.query('SELECT credits_balance FROM users WHERE id = $1', [userId]);
    const balance = parseFloat(user.rows[0].credits_balance);

    if (balance < estimatedCost) {
      return res.status(402).json({ 
        error: 'Insufficient credits',
        required: estimatedCost,
        current: balance
      });
    }

    // 4. Deduct credits immediately (hold)
    await db.query(
      'UPDATE users SET credits_balance = credits_balance - $1 WHERE id = $2',
      [estimatedCost, userId]
    );

    // 5. Create job record
    const jobResult = await db.query(
      `INSERT INTO video_jobs 
       (user_id, tier, status, prompt, negative_prompt, input_image_url, 
        duration_seconds, estimated_cost, user_charged)
       VALUES ($1, $2, 'pending', $3, $4, $5, $6, $7, $8)
       RETURNING id`,
      [userId, tier, prompt, negativePrompt, image, duration, 
       duration * tierConfig.basePrice, estimatedCost]
    );

    const jobId = jobResult.rows[0].id;

    // 6. Record transaction
    await db.query(
      `INSERT INTO transactions (user_id, job_id, amount, type, description)
       VALUES ($1, $2, $3, 'charge', $4)`,
      [userId, jobId, estimatedCost, `${tierConfig.name} video generation`]
    );

    // 7. Submit to Pollo.ai
    const generator = new PolloVideoGenerator(process.env.POLLO_API_KEY);
    const result = await generator.generateVideo(tier, {
      prompt,
      negativePrompt,
      image,
      duration,
      webhookUrl: `${process.env.APP_URL}/api/webhooks/pollo`
    });

    // 8. Update job with taskId
    await db.query(
      'UPDATE video_jobs SET task_id = $1, status = $2 WHERE id = $3',
      [result.taskId, 'processing', jobId]
    );

    res.json({
      jobId,
      taskId: result.taskId,
      status: 'processing',
      estimatedCost,
      estimatedTime: '2-5 minutes'
    });

  } catch (error) {
    console.error('Generation error:', error);
    
    // Refund on error
    if (estimatedCost) {
      await db.query(
        'UPDATE users SET credits_balance = credits_balance + $1 WHERE id = $2',
        [estimatedCost, userId]
      );
    }

    res.status(500).json({ error: 'Generation failed' });
  }
});
```

### 4.2 Status Check Endpoint

```javascript
app.get('/api/videos/:jobId/status', authenticate, async (req, res) => {
  const { jobId } = req.params;
  const userId = req.user.id;

  const result = await db.query(
    'SELECT * FROM video_jobs WHERE id = $1 AND user_id = $2',
    [jobId, userId]
  );

  if (!result.rows[0]) {
    return res.status(404).json({ error: 'Job not found' });
  }

  res.json(result.rows[0]);
});
```

---

## 5. Monetization & Payment Integration

### 5.1 Credit Packages

```javascript
const CREDIT_PACKAGES = {
  starter: {
    credits: 10.00,
    price: 9.99,
    bonus: 0,
    popular: false
  },
  standard: {
    credits: 25.00,
    price: 24.99,
    bonus: 2.00,
    popular: false
  },
  pro: {
    credits: 50.00,
    price: 47.99,
    bonus: 5.00,
    popular: true
  },
  enterprise: {
    credits: 100.00,
    price: 89.99,
    bonus: 15.00,
    popular: false
  }
};
```

### 5.2 Stripe Integration

```javascript
// Purchase credits endpoint
app.post('/api/credits/purchase', authenticate, async (req, res) => {
  const { packageId } = req.body;
  const userId = req.user.id;
  const package = CREDIT_PACKAGES[packageId];

  if (!package) {
    return res.status(400).json({ error: 'Invalid package' });
  }

  // Create Stripe checkout session
  const session = await stripe.checkout.sessions.create({
    customer_email: req.user.email,
    payment_method_types: ['card'],
    line_items: [{
      price_data: {
        currency: 'usd',
        product_data: {
          name: `${packageId.toUpperCase()} Credits Package`,
          description: `${package.credits + package.bonus} video generation credits`
        },
        unit_amount: Math.round(package.price * 100)
      },
      quantity: 1
    }],
    mode: 'payment',
    success_url: `${process.env.APP_URL}/credits/success?session_id={CHECKOUT_SESSION_ID}`,
    cancel_url: `${process.env.APP_URL}/credits`,
    metadata: {
      userId,
      packageId,
      credits: package.credits + package.bonus
    }
  });

  res.json({ sessionId: session.id, url: session.url });
});

// Stripe webhook handler
app.post('/api/webhooks/stripe', async (req, res) => {
  const sig = req.headers['stripe-signature'];
  let event;

  try {
    event = stripe.webhooks.constructEvent(
      req.body,
      sig,
      process.env.STRIPE_WEBHOOK_SECRET
    );
  } catch (err) {
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  if (event.type === 'checkout.session.completed') {
    const session = event.data.object;
    const { userId, credits } = session.metadata;

    // Add credits to user account
    await db.query(
      'UPDATE users SET credits_balance = credits_balance + $1 WHERE id = $2',
      [parseFloat(credits), userId]
    );

    // Record transaction
    await db.query(
      `INSERT INTO transactions (user_id, amount, type, description)
       VALUES ($1, $2, 'credit_purchase', $3)`,
      [userId, parseFloat(credits), `Purchased ${credits} credits`]
    );
  }

  res.json({ received: true });
});
```

---

## 6. Frontend UI Components

### 6.1 Tier Selection Component

```jsx
const TierSelector = ({ onSelect, selectedTier }) => {
  const tiers = [
    {
      id: 'basic',
      name: 'Basic',
      price: '$0.31/sec',
      features: [
        'Fast generation',
        'Good quality',
        'Up to 8 seconds',
        'Text & Image input'
      ],
      color: 'blue'
    },
    {
      id: 'pro',
      name: 'Pro',
      price: '$0.37/sec',
      features: [
        'Director-level quality',
        'Pro camera control',
        'Up to 10 seconds',
        'Enhanced motion'
      ],
      color: 'purple',
      popular: true
    },
    {
      id: 'premium',
      name: 'Premium',
      price: '$0.93/sec',
      features: [
        'Hollywood quality',
        'Ultra-realistic',
        '4K support',
        'Maximum detail'
      ],
      color: 'gold'
    }
  ];

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
      {tiers.map(tier => (
        <div 
          key={tier.id}
          className={`border rounded-lg p-6 cursor-pointer transition ${
            selectedTier === tier.id ? 'border-blue-500 shadow-lg' : ''
          }`}
          onClick={() => onSelect(tier.id)}
        >
          {tier.popular && (
            <span className="bg-blue-500 text-white px-3 py-1 rounded-full text-sm">
              Most Popular
            </span>
          )}
          <h3 className="text-2xl font-bold mt-2">{tier.name}</h3>
          <p className="text-3xl font-bold text-blue-600 mt-2">{tier.price}</p>
          <ul className="mt-4 space-y-2">
            {tier.features.map((feature, i) => (
              <li key={i} className="flex items-center">
                <span className="text-green-500 mr-2">✓</span>
                {feature}
              </li>
            ))}
          </ul>
        </div>
      ))}
    </div>
  );
};
```

### 6.2 Cost Calculator

```jsx
const CostCalculator = ({ tier, duration }) => {
  const calculateCost = () => {
    const rates = {
      basic: 0.31,
      pro: 0.37,
      premium: 0.93
    };
    return (rates[tier] * duration).toFixed(2);
  };

  return (
    <div className="bg-gray-100 p-4 rounded-lg">
      <h4 className="font-semibold">Estimated Cost</h4>
      <p className="text-2xl font-bold text-blue-600">
        ${calculateCost()}
      </p>
      <p className="text-sm text-gray-600">
        {duration} seconds × ${TIER_CONFIG[tier].customerPrice}/sec
      </p>
    </div>
  );
};
```

---

## 7. Error Handling & Edge Cases

### 7.1 Error Scenarios

```javascript
const ERROR_HANDLERS = {
  insufficient_credits: (user, required) => ({
    code: 'INSUFFICIENT_CREDITS',
    message: 'You need more credits to generate this video',
    action: 'purchase_credits',
    details: {
      required,
      current: user.credits_balance,
      shortfall: required - user.credits_balance
    }
  }),

  api_error: (error) => ({
    code: 'API_ERROR',
    message: 'Pollo.ai service temporarily unavailable',
    action: 'retry',
    refund: true
  }),

  invalid_input: (details) => ({
    code: 'INVALID_INPUT',
    message: 'Your input contains errors',
    action: 'correct_input',
    details
  }),

  generation_failed: (reason) => ({
    code: 'GENERATION_FAILED',
    message: 'Video generation failed',
    action: 'retry',
    refund: true,
    reason
  })
};
```

### 7.2 Retry Logic

```javascript
async function generateWithRetry(tier, params, maxRetries = 3) {
  let lastError;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await generator.generateVideo(tier, params);
    } catch (error) {
      lastError = error;
      
      if (attempt < maxRetries) {
        // Exponential backoff
        await new Promise(resolve => 
          setTimeout(resolve, Math.pow(2, attempt) * 1000)
        );
      }
    }
  }
  
  throw lastError;
}
```

---

## 8. Monitoring & Analytics

### 8.1 Key Metrics to Track

```sql
-- Revenue analytics
CREATE VIEW revenue_analytics AS
SELECT 
  DATE(created_at) as date,
  tier,
  COUNT(*) as generations,
  SUM(user_charged) as revenue,
  SUM(estimated_cost) as costs,
  SUM(user_charged - estimated_cost) as profit,
  AVG(duration_seconds) as avg_duration
FROM video_jobs
WHERE status = 'completed'
GROUP BY DATE(created_at), tier;

-- User analytics
CREATE VIEW user_analytics AS
SELECT 
  u.id,
  u.email,
  COUNT(vj.id) as total_videos,
  SUM(vj.user_charged) as total_spent,
  MAX(vj.created_at) as last_generation,
  u.credits_balance
FROM users u
LEFT JOIN video_jobs vj ON u.id = vj.user_id
GROUP BY u.id, u.email, u.credits_balance;
```

### 8.2 Health Checks

```javascript
app.get('/api/health', async (req, res) => {
  const checks = {
    database: await checkDatabase(),
    pollo_api: await checkPolloAPI(),
    stripe: await checkStripe(),
    webhook_receiver: true
  };

  const healthy = Object.values(checks).every(status => status);

  res.status(healthy ? 200 : 503).json({
    status: healthy ? 'healthy' : 'degraded',
    checks,
    timestamp: new Date().toISOString()
  });
});
```

---

## 9. Implementation Timeline

### Phase 1: Core Infrastructure (Week 1-2)
- [ ] Database schema setup
- [ ] Basic API endpoints
- [ ] Pollo.ai integration
- [ ] Authentication system

### Phase 2: Payment & Credits (Week 3)
- [ ] Stripe integration
- [ ] Credit purchase flow
- [ ] Transaction logging
- [ ] Refund logic

### Phase 3: Video Generation (Week 4)
- [ ] Generation endpoints (all tiers)
- [ ] Webhook handler
- [ ] Status polling
- [ ] Error handling

### Phase 4: Frontend (Week 5-6)
- [ ] Tier selection UI
- [ ] Video generation form
- [ ] Status dashboard
- [ ] Credit purchase page
- [ ] Video gallery

### Phase 5: Testing & Launch (Week 7)
- [ ] Load testing
- [ ] Security audit
- [ ] Cost validation
- [ ] Beta launch

---

## 10. Security Considerations

### 10.1 API Key Management
```javascript
// Never expose Pollo.ai API key to frontend
// Store in environment variables
// Rotate keys quarterly
// Use separate keys for dev/staging/prod
```

### 10.2 Rate Limiting
```javascript
const rateLimit = require('express-rate-limit');

const generateLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 10, // 10 requests per window per user
  message: 'Too many generation requests, please try again later'
});

app.post('/api/videos/generate', generateLimiter, authenticate, ...);
```

### 10.3 Input Validation
```javascript
const Joi = require('joi');

const generateSchema = Joi.object({
  tier: Joi.string().valid('basic', 'pro', 'premium').required(),
  prompt: Joi.string().min(10).max(1000).required(),
  negativePrompt: Joi.string().max(500),
  duration: Joi.number().min(5).max(10).required(),
  image: Joi.string().uri().optional()
});
```

---

## 11. Cost Optimization Tips

1. **Batch Processing**: Queue multiple jobs to reduce overhead
2. **Caching**: Cache common prompts/results (if legally allowed)
3. **Smart Routing**: Use Basic tier for simple requests automatically
4. **Credit Expiry**: Implement 90-day credit expiry to reduce liability
5. **Volume Discounts**: Negotiate with Pollo.ai for volume pricing

---

## 12. Support & Documentation

### 12.1 User Documentation Needed
- How to choose the right tier
- Prompt engineering guide
- Image requirements
- Troubleshooting common issues
- Refund policy

### 12.2 API Documentation
- Generate comprehensive API docs (Swagger/OpenAPI)
- Include code examples in multiple languages
- Provide Postman collection

---

## Appendix A: Environment Variables

```bash
# Pollo.ai
POLLO_API_KEY=your_api_key_here

# Stripe
STRIPE_SECRET_KEY=sk_live_xxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxx

# Database
DATABASE_URL=postgresql://user:pass@host:5432/dbname

# Application
APP_URL=https://yourdomain.com
JWT_SECRET=your_jwt_secret
NODE_ENV=production

# Monitoring (optional)
SENTRY_DSN=https://xxxxx@sentry.io/xxxxx
```

---

## Appendix B: Sample API Requests

### Generate Basic Video
```bash
curl -X POST https://yourapp.com/api/videos/generate \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "tier": "basic",
    "prompt": "A golden retriever running through a sunlit meadow",
    "duration": 5
  }'
```

### Purchase Credits
```bash
curl -X POST https://yourapp.com/api/credits/purchase \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "packageId": "pro"
  }'
```

---

## Support Contact

For implementation questions:
- Technical: dev@yourcompany.com
- Pollo.ai Support: support@pollo.ai
- Stripe Support: support@stripe.com

---

**Document Version**: 1.0  
**Last Updated**: October 29, 2025  
**Next Review**: Q1 2026
